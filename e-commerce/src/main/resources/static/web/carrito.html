
<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Carrito de Compras</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="./assets/style.css">
</head>
<body class="bg-dark text-white">

<div id="app" class="container mt-5">

  <h2 class="text-center mb-4">Carrito de Compras</h2>

  <div v-if="carrito.length > 0">
    <table class="table table-dark table-striped">
      <thead>
        <tr>
          <th>Producto</th>
          <th>Cantidad</th>
          <th>Precio</th>
          <th>Subtotal</th>
          <th>Acciones</th>
        </tr>
      </thead>
      <tbody>
        <tr v-for="(item, index) in carrito" :key="item.id">
          <td>{{ item.nombre }}</td>
          <td>
            <button @click="modificarCantidad(index, -1)" class="btn btn-sm btn-secondary">-</button>
            {{ item.cantidad }}
            <button @click="modificarCantidad(index, 1)" class="btn btn-sm btn-secondary">+</button>
          </td>
          <td>${{ item.precio }}</td>
          <td>${{ item.precio * item.cantidad }}</td>
          <td><button @click="eliminarProducto(index)" class="btn btn-danger btn-sm">Eliminar</button></td>
        </tr>
      </tbody>
    </table>

    <h4 class="text-end">Total: ${{ total }}</h4>

    <div class="text-center mt-4">
      <button class="btn btn-success" @click="pagar">Pagar con Mercado Pago</button>
    </div>
  </div>

  <div v-else class="text-center mt-5">
    <p>No hay productos en el carrito.</p>
  </div>

  <!-- Modal de compra exitosa -->
  <div class="modal fade" id="modalExito" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Â¡Pago exitoso!</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
      </div>
      <div class="modal-body">Tu compra fue registrada correctamente.</div>
      <div class="modal-footer">
        <button type="button" class="btn btn-primary" data-bs-dismiss="modal">Aceptar</button>
      </div>
    </div>
  </div>
</div>


</div>

<script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
<script>
const { createApp } = Vue;

createApp({
  data() {
    return {
      carrito: []
    };
  },
  computed: {
    total() {
      return this.carrito.reduce((acc, item) => acc + item.precio * item.cantidad, 0);
    }
  },
  methods: {
    modificarCantidad(index, cantidad) {
      const nuevaCantidad = this.carrito[index].cantidad + cantidad;
      if (nuevaCantidad > 0) {
        this.carrito[index].cantidad = nuevaCantidad;
        this.guardarCarrito();
      }
    },
    eliminarProducto(index) {
      this.carrito.splice(index, 1);
      this.guardarCarrito();
    },
    guardarCarrito() {
      localStorage.setItem('carrito', JSON.stringify(this.carrito));
    },
    pagar() {
      const items = this.carrito.map(item => ({
        title: item.nombre,
        quantity: item.cantidad,
        unit_price: item.precio,
        currency_id: "COP"
      }));

      axios.post("/api/mercadopago/create-preference", items)
        .then(res => {
          window.location.href = res.data.init_point;
        })
        .catch(err => {
          console.error("Error al iniciar el pago", err);
        });
    },
    verificarPagoExitoso() {
      const params = new URLSearchParams(window.location.search);
      if (params.get("status") === "success") {
        const modal = new bootstrap.Modal(document.getElementById("modalExito"));
        modal.show();
        localStorage.removeItem("carrito");
        this.carrito = [];
      }
    }
  },
  mounted() {
    this.carrito = JSON.parse(localStorage.getItem('carrito') || '[]');
    this.verificarPagoExitoso();
  }
}).mount("#app");
</script>
</body>
</html>
